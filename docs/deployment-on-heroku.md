## Configuration and deployment for the Source website
The Source website is a Django application, with a staging site and a public-facing production site that run as Heroku applications.

### Heroku configuration
The `production` application is configured with the following add-ons (and costs as of Jan 2017):

* Heroku Standard-1X Dynos: 1 dyno ($25/month)
* Heroku Postgres: Standard-0 plan ($50/month)
* Bonsai Elasticsearch: Staging plan ($10/month)
* Memcached Cloud: 250MB plan ($24/month)
* Papertrail: Fixa plan ($7/month)
* Mailgun: Starter plan (free)
* Heroku Scheduler (free)
* SSL FastTrack: Single Domain plan ($14/month)

The `staging` application is configured with free versions of the same add-ons, other than:

* Heroku Hobby Dynos ($7/month)
* Heroku Postgres: Hobby Basic plan ($9/month)
* SSL FastTrack (unnecessary on staging)

### Deployment
The `production` and `staging` applications are part of a [Heroku deployment pipeline](https://devcenter.heroku.com/articles/pipelines). Per Heroku convention, this pipeline is named after the production app. It is connected to the [opennews/opennews-source GitHub repository](https://github.com/OpenNews/opennews-source/).

The staging and production applications each have their own database and deployment environment.

**Updating the staging site**
The `staging` application is assigned to the `staging` stage of the pipeline, and configured for automatic deployments. Any push to the `master` branch of this GitHub repository will trigger an automatic rebuild of the Heroku `staging` application.

Staging deployments can also be made manually from alternative branches of the repository, [via command line](https://devcenter.heroku.com/articles/git#deploying-code) or, more easily, from the "Deploy" tab of the `staging` application dashboard on Heroku. It is possible to enable Heroku "review applications" as well; these are automatically spawned when a new Pull Request is opened. Based on our current development team size and workflow, we aren't using these.

**Updating the production site**
The `production` application is assigned to the `production` stage of the pipeline, and configured for manual deployment. This can be done [via the command line](https://devcenter.heroku.com/articles/pipelines#promoting) or, more easily, by clicking "Promote to production..." on the staging app in the Heroku pipeline dashboard.

It is also possible, to deploy an alternate branch of the repository directly to production. This would be initiated from the "Deploy" tab of the `production` application dashboard on Heroku.

NOTE: In cases where a database schema migration is required, promoting the `staging` application to `production` will not work. Heroku pipeline promotions copy compiled code from one application to another, and do not trigger the build process that applies database migrations. In these cases, use the "Deploy" tab of the `production` application dashboard on Heroku, and initiate a manual build from the `master` branch of the repository.

### Required configuration variables
The following config variables must be set via command line with `heroku config:set` or through the "Settings" tab on each application's Heroku dashboard. (For local development, these would be set through something like `postactivate` on your virtualenv.)

**Django app variables**
* DJANGO_SETTINGS_MODULE (should be set to config.settings.production)
* DJANGO_SECRET_KEY
* DJANGO_ALLOWED_HOSTS
* BASE_URL (should be set to website URL, used by caching utils)

**Third-party app variables**
These sets of variables are generated by their respective third-party applications, and stored in the environment for use by features on the Source website.
* TWITTER_CONSUMER_KEY
* TWITTER_CONSUMER_SECRET
* TWITTER_ACCESS_TOKEN
* TWITTER_ACCESS_TOKEN_SECRET
* JOBS_TWITTER_CONSUMER_KEY
* JOBS_TWITTER_CONSUMER_SECRET
* JOBS_TWITTER_ACCESS_TOKEN
* JOBS_TWITTER_ACCESS_TOKEN_SECRET
* GITHUB_CLIENT_ID
* GITHUB_CLIENT_SECRET
* SLACK_TOKEN
* AWS_S3_ACCESS_KEY_ID
* AWS_S3_SECRET_ACCESS_KEY
* AUTH0_DOMAIN
* AUTH0_CLIENT_ID
* AUTH0_SECRET
* LOCKDOWN_ENABLED
* LOCKDOWN_PASSWORDS

**Heroku add-on variables**
Further config variables will be automatically set by their Heroku add-ons.

### HTTPS
The `production` application on Heroku uses the [SSL FastTrack](https://devcenter.heroku.com/articles/sslfasttrack) add-on to provision the Source website's SSL certificate, and [Django's security middleware](https://docs.djangoproject.com/en/1.10/ref/middleware/#module-django.middleware.security) to force traffic to HTTPS.

### Media files
Static media files included in the [opennews/opennews-source GitHub repository](https://github.com/OpenNews/opennews-source/) (javascript, CSS, images for UI/UX components, etc.) are part of each deployment, and are served by [whitenoise](http://whitenoise.evans.io/en/stable/).

Each application uses [django-storages](https://django-storages.readthedocs.io/en/latest/) to send uploaded media files (article images, code screenshots, etc.) to an Amazon S3 bucket. For the `staging` and `production` websites, these files are served by a Cloudfront distribution with a standard cache time of 86400 seconds (or 1 day). If a file is missing, the distribution caches a 404 response for 5 minutes.
